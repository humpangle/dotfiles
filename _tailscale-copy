
# =============================================================================
# Tailscale File Transfer Utilities
# =============================================================================
#
# tscp - Interactive file sender with fzf peer selection
#   Usage: tscp
#
#   Workflow:
#     1. Opens fzf to select an active Tailscale peer
#     2. Prompts for files to send (supports globs like *.jpg)
#     3. Sends files to selected peer using tailscale file cp
#
#   Examples:
#     $ tscp
#     # Select peer from fzf, then enter files:
#     Enter files to send to alayadev: document.pdf
#
#     $ tscp
#     # Select peer, then send multiple files:
#     Enter files to send to alayadev: file1.txt file2.txt *.jpg
#
#     $ tscp
#     # Select peer, then send file with spaces (use quotes):
#     Enter files to send to alayadev: "my document.pdf" photo.jpg
#
# tsget - Get files from Tailscale with custom target directory
#   Usage: tsget [target_directory]
#
#   Downloads files sent via Tailscale to a specified directory.
#   If no directory is provided, prompts for input.
#   Defaults to ~/Downloads if no input given.
#
#   Examples:
#     $ tsget ~/Documents
#     Getting files to: /home/user/Documents
#
#     $ tsget
#     Enter target directory: ~/Projects
#     Getting files to: /home/user/Projects
#
#     $ tsget
#     Enter target directory:
#     Using default directory: /home/user/Downloads
#
# tsl - List active Tailscale peers
#   Usage: tsl
#
#   Displays a formatted list of active peers with their IP, name, and user.
#   Excludes the current machine.
#
# =============================================================================

# Send files to Tailscale peer with fzf selection
__fzf_tailscale_send__() {
  local peer_name files

  # Get active peers (excluding current machine which has trailing -)
  # Parse output to extract peer names
  # shellcheck disable=SC2091
  peer_name=$(
    tailscale status --active 2>/dev/null |
      grep -v ' \-$' |               # Exclude current machine (has trailing -)
      grep 'active;' |               # Only active peers
      awk '{print $2, "(" $1 ")"}' | # Show peer name and IP
      FZF_DEFAULT_OPTS=$(__fzf_defaults "--reverse --prompt='Select Tailscale peer: '" "${FZF_TAILSCALE_OPTS-} +m") \
      FZF_DEFAULT_OPTS_FILE='' $(__fzfcmd) |
      awk '{print $1}' # Extract just the peer name
  ) || return

  if [[ -n "$peer_name" ]]; then
    # Prompt for files
    read -r -p "Enter files to send to ${peer_name}: " files

    if [[ -z "$files" ]]; then
      echo "No files specified. Cancelled."
      return 1
    fi

    echo "Sending files to ${peer_name}..."
    # Use eval to properly expand the files string (handles spaces, globs, etc.)
    eval "tailscale file cp ${files} ${peer_name}:"
  fi
}
alias tscp='__fzf_tailscale_send__'

# List active Tailscale peers
__list_tailscale_peers__() {
  tailscale status --active 2>/dev/null |
    grep -v ' \-$' |
    grep 'active;' |
    awk '{printf "%-15s %-20s %s\n", $1, $2, $3}'
}
alias tsl='__list_tailscale_peers__'

# Get files from Tailscale with custom target directory
__tailscale_file_get__() {
  local target_dir

  # Check if argument provided, otherwise read from stdin
  if [[ -n "$1" ]]; then
    target_dir="$1"
  else
    read -r -p "Enter target directory: " target_dir
  fi

  # Use default if empty
  if [[ -z "$target_dir" ]]; then
    target_dir="$HOME/Downloads"
    echo "Using default directory: ${target_dir}"
  fi

  # Expand tilde and resolve path
  target_dir="${target_dir/#\~/$HOME}"

  # Create directory if it doesn't exist
  if [[ ! -d "$target_dir" ]]; then
    echo "Directory does not exist: ${target_dir}"
    read -r -p "Create it? (y/n): " create_dir
    if [[ "$create_dir" == "y" ]]; then
      mkdir -p "$target_dir" || {
        echo "Failed to create directory"
        return 1
      }
    else
      echo "Cancelled."
      return 1
    fi
  fi

  echo "Getting files to: ${target_dir}"
  tailscale file get --conflict=rename "$target_dir"
}
alias tsget='__tailscale_file_get__'
alias tsget__description='tailscale file get receive'
