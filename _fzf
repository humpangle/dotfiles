#!/usr/bin/env bash

if [ ! -d "$HOME/.fzf" ]; then
  return
fi

if [[ -e "$HOME/.fzf.bash" ]]; then
  # shellcheck source=/dev/null
  source "$HOME/.fzf.bash"

  # Set up fzf key bindings and fuzzy completion
  eval "$(fzf --bash)"
fi

# ripgrep
export RG_IGNORES="!{.git,node_modules,cover,coverage,.elixir_ls,deps,_build,.build,build}"
export RG_IGNORES=
RG_OPTIONS="--hidden --follow --glob '$RG_IGNORES'"

export FZF_DEFAULT_OPTS="--layout=reverse --border"
# Use git-ls-files inside git repo, otherwise rg
export FZF_DEFAULT_COMMAND="rg --files $RG_OPTIONS"
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_COMPLETION_TRIGGER=',,'
export FZF_ALIAS_OPTS="--height=40% --border-label='Aliases' --border-label-pos=2 --prompt='Alias> '"
export FZF_PATH_ENV_OPTS="--height=40% --border-label='PATH Directories' --border-label-pos=2 --prompt='Path> '"
export FZF_PATH_ALL_OPTS="--height=80% --border-label='PATH Files' --border-label-pos=2 --prompt='File> ' --preview='[[ \$(file --mime {}) =~ binary ]] && echo {} is a binary file || (bat --style=numbers --color=always {} || cat {}) 2> /dev/null | head -300'"

_fzf_compgen_dir() {
  rg --files "$RG_OPTIONS"
}

_fzf_compgen_path() {
  rg --files --hidden --follow --glob "$RG_IGNORES"
}

FZF_PREVIEW_APP="--preview='[[ \$(file --mime {}) =~ binary ]] && echo {} is a binary file || (bat --style=numbers --color=always {} || cat {}) 2> /dev/null | head -300'"

# shellcheck disable=2139
alias ff="fzf $FZF_PREVIEW_APP"
alias eff='env | fzf'
alias fff='compgen -A function | fzf'

__fzf_alias__() {
  local output
  output=$(
    alias |
      command awk -F'=' '{
        alias_name = $1
        sub(/^alias /, "", alias_name)
        alias_value = substr($0, index($0, "=") + 1)
        # Remove quotes around the value
        gsub(/^'"'"'|'"'"'$/, "", alias_value)
        printf "%-20s %s\n", alias_name, alias_value
      }' |
      FZF_DEFAULT_OPTS=$(__fzf_defaults "--reverse" "${FZF_ALIAS_OPTS-} +m") \
      FZF_DEFAULT_OPTS_FILE='' $(__fzfcmd)
  ) || return
  local result=""
  result="$(
    # Extract just the alias name (first field) from the output
    echo "$output" | command awk '{print $1}'
  )"
  echo "$result" | copy
  echo "$result"
}
alias aff='__fzf_alias__'

__fzf_paths__() {
  local output
  output=$(
    echo "$PATH" |
      command tr ':' '\n' |
      FZF_DEFAULT_OPTS=$(__fzf_defaults "--reverse" "${FZF_PATH_ENV_OPTS-} +m") \
      FZF_DEFAULT_OPTS_FILE='' $(__fzfcmd)
  ) || return
  echo "$output" | copy
  echo "$output"
}
alias pff='__fzf_paths__'

__fzf_paths_all__() {
  local output
  output=$(
    echo "$PATH" |
      command tr ':' '\n' |
      while IFS= read -r dir; do
        if [[ -d "$dir" ]]; then
          command find "$dir" -maxdepth 1 \( -type f -o -type l \) 2>/dev/null
        fi
      done |
      FZF_DEFAULT_OPTS=$(__fzf_defaults "--reverse" "${FZF_PATH_ALL_OPTS-} +m") \
      FZF_DEFAULT_OPTS_FILE='' $(__fzfcmd)
  ) || return
  echo "$output" | copy
  echo "$output"
}
alias pffa='__fzf_paths_all__'
